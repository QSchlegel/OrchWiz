// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  emailVerified Boolean @default(false)
  name      String?
  githubId  String?  @unique
  avatarUrl String?
  role      UserRole @default(captain)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions         Session[]
  authSessions     AuthSession[]
  accounts         Account[]
  passkeys         Passkey[]
  commandExecutions CommandExecution[]
  guidanceRevisions GuidanceRevision[]
  agentDeployments  AgentDeployment[]
  applicationDeployments ApplicationDeployment[]
  projects              Project[]
  forwardingConfigs     ForwardingConfig[]
  shipTopologies        ShipTopology[]
  bridgeThreads         BridgeThread[]       @relation("BridgeThreadUser")
  bridgeCallRounds      BridgeCallRound[]
  observabilityTraces   ObservabilityTrace[]
  agentSyncPreference   AgentSyncPreference?
  agentSyncSignals      AgentSyncSignal[]
  agentSyncRuns         AgentSyncRun[]
  agentSyncSuggestions  AgentSyncSuggestion[]
}

enum UserRole {
  captain
  admin
}

model AuthSession {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Account {
  id           String   @id @default(cuid())
  accountId    String
  providerId   String
  userId       String
  accessToken  String?
  refreshToken String?
  idToken      String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope        String?
  password     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([providerId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@index([identifier])
}

model Passkey {
  id           String   @id @default(cuid())
  name         String?
  publicKey    String
  userId       String
  credentialID String   @unique
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  createdAt    DateTime? @default(now())
  aaguid       String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Session {
  id             String   @id @default(uuid())
  title          String?
  description    String?
  prompt         String?
  status         SessionStatus @default(planning)
  mode           SessionMode @default(plan)
  source         SessionSource @default(web)
  projectName    String?
  branch         String?
  environment    String?
  userId         String
  parentSessionId String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  completedAt    DateTime?

  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentSession     Session?             @relation("SessionFork", fields: [parentSessionId], references: [id])
  childSessions     Session[]            @relation("SessionFork")
  interactions      SessionInteraction[]
  commandExecutions CommandExecution[]
  agentActions      AgentAction[]
  hooks             HookExecution[]
  tasks             Task[]
  verificationRuns  VerificationRun[]
  bridgeThread      BridgeThread?            @relation("BridgeThreadSession")
  bridgeMirrorJobs  BridgeMirrorJob[]        @relation("BridgeMirrorJobSession")
  observabilityTraces ObservabilityTrace[]
}

enum SessionStatus {
  planning
  executing
  completed
  paused
  failed
}

enum SessionMode {
  plan
  auto_accept
}

enum SessionSource {
  local
  web
  ios
  terminal_handoff
}

model SessionInteraction {
  id        String   @id @default(cuid())
  sessionId String
  type      InteractionType
  content   String
  metadata  Json?
  timestamp DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  bridgeMirrorLink BridgeMirrorLink?
  bridgeMirrorJobs BridgeMirrorJob[] @relation("BridgeMirrorJobInteraction")

  @@index([sessionId])
  @@index([timestamp])
}

enum InteractionType {
  user_input
  ai_response
  tool_use
  error
}

enum BridgeChatRole {
  user
  assistant
  system
}

enum BridgeMirrorDirection {
  thread_to_session
  session_to_thread
}

enum BridgeMirrorJobStatus {
  pending
  processing
  completed
  failed
}

model BridgeThread {
  id         String         @id @default(uuid())
  title      String
  userId     String?
  stationKey BridgeCrewRole?
  sessionId  String?        @unique
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  user       User?          @relation("BridgeThreadUser", fields: [userId], references: [id], onDelete: SetNull)
  session    Session?       @relation("BridgeThreadSession", fields: [sessionId], references: [id], onDelete: SetNull)
  messages   BridgeMessage[]
  mirrorJobs BridgeMirrorJob[]

  @@unique([userId, stationKey])
  @@index([userId])
  @@index([stationKey])
  @@index([updatedAt])
}

model BridgeMessage {
  id         String           @id @default(uuid())
  threadId   String
  role       BridgeChatRole
  content    String
  createdAt  DateTime         @default(now())

  thread      BridgeThread    @relation(fields: [threadId], references: [id], onDelete: Cascade)
  mirrorLink  BridgeMirrorLink?
  mirrorJobs  BridgeMirrorJob[]

  @@index([threadId, createdAt])
  @@index([createdAt])
}

model BridgeMirrorLink {
  id            String             @id @default(cuid())
  messageId     String             @unique
  interactionId String             @unique
  createdAt     DateTime           @default(now())

  message       BridgeMessage      @relation(fields: [messageId], references: [id], onDelete: Cascade)
  interaction   SessionInteraction @relation(fields: [interactionId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}

model BridgeMirrorJob {
  id            String               @id @default(cuid())
  dedupeKey     String               @unique
  direction     BridgeMirrorDirection
  status        BridgeMirrorJobStatus @default(pending)
  attempts      Int                  @default(0)
  nextAttemptAt DateTime?
  lastError     String?
  threadId      String?
  sessionId     String?
  messageId     String?
  interactionId String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  thread        BridgeThread?        @relation(fields: [threadId], references: [id], onDelete: SetNull)
  session       Session?             @relation("BridgeMirrorJobSession", fields: [sessionId], references: [id], onDelete: SetNull)
  message       BridgeMessage?       @relation(fields: [messageId], references: [id], onDelete: SetNull)
  interaction   SessionInteraction?  @relation("BridgeMirrorJobInteraction", fields: [interactionId], references: [id], onDelete: SetNull)

  @@index([status, nextAttemptAt])
  @@index([direction])
  @@index([threadId])
  @@index([sessionId])
  @@index([messageId])
  @@index([interactionId])
  @@index([createdAt])
}

enum BridgeCallRoundSource {
  operator
  system
}

enum BridgeCallRoundStatus {
  pending
  running
  completed
  partial
  failed
}

enum BridgeCallOfficerResultStatus {
  success
  offline
  failed
}

model BridgeCallRound {
  id               String                        @id @default(cuid())
  userId           String
  shipDeploymentId String?
  directive        String
  source           BridgeCallRoundSource         @default(operator)
  status           BridgeCallRoundStatus         @default(pending)
  leadStationKey   BridgeCrewRole?
  summary          String?
  metadata         Json?
  createdAt        DateTime                      @default(now())
  completedAt      DateTime?

  user             User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  shipDeployment   AgentDeployment?              @relation("BridgeCallRoundShip", fields: [shipDeploymentId], references: [id], onDelete: SetNull)
  officerResults   BridgeCallOfficerResult[]

  @@index([userId, createdAt])
  @@index([userId, shipDeploymentId, createdAt])
  @@index([shipDeploymentId])
}

model BridgeCallOfficerResult {
  id                String                       @id @default(cuid())
  roundId           String
  stationKey        BridgeCrewRole
  callsign          String
  status            BridgeCallOfficerResultStatus
  wasRetried        Boolean                      @default(false)
  attemptCount      Int                          @default(1)
  error             String?
  summary           String?
  threadId          String?
  sessionId         String?
  userInteractionId String?
  aiInteractionId   String?
  provider          String?
  fallbackUsed      Boolean?
  latencyMs         Int?
  createdAt         DateTime                     @default(now())

  round             BridgeCallRound              @relation(fields: [roundId], references: [id], onDelete: Cascade)

  @@unique([roundId, stationKey])
  @@index([roundId])
  @@index([stationKey])
  @@index([status])
}

model Command {
  id            String   @id @default(cuid())
  name          String
  description   String?
  scriptContent String
  path          String?
  isShared      Boolean  @default(false)
  teamId        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  executions CommandExecution[]

  @@unique([name, teamId])
  @@index([teamId])
}

model CommandExecution {
  id          String   @id @default(cuid())
  commandId   String
  sessionId   String?
  subagentId  String?
  userId      String
  status      ExecutionStatus @default(running)
  output      String?
  error       String?
  duration    Int?
  startedAt   DateTime @default(now())
  completedAt DateTime?

  command Command @relation(fields: [commandId], references: [id], onDelete: Cascade)
  session Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  subagent Subagent? @relation(fields: [subagentId], references: [id], onDelete: SetNull)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([commandId])
  @@index([sessionId])
  @@index([subagentId])
  @@index([userId])
}

enum ExecutionStatus {
  running
  completed
  failed
}

model Subagent {
  id          String   @id @default(cuid())
  name        String
  description String?
  content     String
  path        String?
  settings    Json?
  isShared    Boolean  @default(false)
  teamId      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  deployments AgentDeployment[]
  permissions Permission[]
  permissionPolicies SubagentPermissionPolicy[]
  commandExecutions CommandExecution[]
  agentSyncSignals AgentSyncSignal[]
  agentSyncRuns AgentSyncRun[]
  agentSyncSuggestions AgentSyncSuggestion[]

  @@unique([name, teamId])
  @@index([teamId])
}

model AgentSyncPreference {
  id           String   @id @default(cuid())
  userId       String   @unique
  timezone     String   @default("UTC")
  nightlyEnabled Boolean @default(true)
  nightlyHour  Int      @default(2)
  lastNightlyRunAt DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AgentSyncSignal {
  id          String              @id @default(cuid())
  userId      String
  subagentId  String
  source      AgentSyncSignalSource
  sourceId    String
  reward      Float
  details     Json?
  occurredAt  DateTime
  createdAt   DateTime            @default(now())

  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  subagent    Subagent            @relation(fields: [subagentId], references: [id], onDelete: Cascade)

  @@unique([source, sourceId, subagentId])
  @@index([userId, occurredAt])
  @@index([subagentId, occurredAt])
  @@index([source, occurredAt])
}

model AgentSyncRun {
  id            String                 @id @default(cuid())
  userId        String
  subagentId    String?
  trigger       AgentSyncTrigger
  scope         AgentSyncScope
  status        AgentSyncRunStatus     @default(pending)
  summary       String?
  error         String?
  fileSyncStatus AgentSyncFileSyncStatus @default(skipped)
  metadata      Json?
  startedAt     DateTime               @default(now())
  completedAt   DateTime?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  subagent      Subagent?              @relation(fields: [subagentId], references: [id], onDelete: SetNull)
  suggestions   AgentSyncSuggestion[]

  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([subagentId, createdAt])
}

model AgentSyncSuggestion {
  id             String                   @id @default(cuid())
  runId          String
  userId         String
  subagentId     String
  fileName       String
  risk           AgentSyncSuggestionRisk
  status         AgentSyncSuggestionStatus @default(proposed)
  reason         String?
  fileSyncStatus AgentSyncFileSyncStatus   @default(skipped)
  existingContent String?
  suggestedContent String
  metadata       Json?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  appliedAt      DateTime?

  run            AgentSyncRun              @relation(fields: [runId], references: [id], onDelete: Cascade)
  user           User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  subagent       Subagent                  @relation(fields: [subagentId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([subagentId, createdAt])
  @@index([status, createdAt])
}

enum AgentSyncTrigger {
  manual
  nightly
}

enum AgentSyncScope {
  selected_agent
  bridge_crew
}

enum AgentSyncRunStatus {
  pending
  running
  completed
  failed
}

enum AgentSyncSignalSource {
  command
  verification
  bridge_call
}

enum AgentSyncSuggestionRisk {
  low
  high
}

enum AgentSyncSuggestionStatus {
  proposed
  applied
  rejected
  failed
}

enum AgentSyncFileSyncStatus {
  synced
  filesystem_sync_failed
  skipped
}

model ClaudeDocument {
  id          String   @id @default(cuid())
  teamId      String?
  title       String
  content     String
  version     Int      @default(1)
  lastUpdated DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  guidanceEntries GuidanceEntry[]

  @@index([teamId])
}

model GuidanceEntry {
  id          String            @id @default(cuid())
  documentId  String
  content     String
  category    String?
  status      GuidanceStatus   @default(active)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  document   ClaudeDocument    @relation(fields: [documentId], references: [id], onDelete: Cascade)
  revisions  GuidanceRevision[]

  @@index([documentId])
  @@index([status])
}

enum GuidanceStatus {
  active
  deprecated
}

model GuidanceRevision {
  id              String   @id @default(cuid())
  guidanceEntryId String
  oldContent      String?
  newContent      String?
  diff            String?
  triggeredBy     String?
  commitHash      String?
  prLink          String?
  botResponse     String?
  timestamp       DateTime @default(now())

  guidanceEntry GuidanceEntry @relation(fields: [guidanceEntryId], references: [id], onDelete: Cascade)
  user          User?         @relation(fields: [triggeredBy], references: [id], onDelete: SetNull)

  @@index([guidanceEntryId])
  @@index([timestamp])
}

model Permission {
  id            String          @id @default(cuid())
  commandPattern String
  type         PermissionType
  status       PermissionStatus
  scope        PermissionScope
  subagentId   String?
  sourceFile   String?
  isShared     Boolean         @default(false)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  subagent     Subagent?       @relation(fields: [subagentId], references: [id], onDelete: SetNull)

  @@index([commandPattern])
  @@index([scope])
  @@index([subagentId])
}

model PermissionPolicy {
  id          String                  @id @default(cuid())
  slug        String                  @unique
  name        String
  description String?
  isSystem    Boolean                 @default(false)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  rules       PermissionPolicyRule[]
  assignments SubagentPermissionPolicy[]
}

model PermissionPolicyRule {
  id             String            @id @default(cuid())
  policyId       String
  commandPattern String
  type           PermissionType
  status         PermissionStatus
  sortOrder      Int               @default(0)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  policy PermissionPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@index([policyId])
  @@index([policyId, sortOrder])
}

model SubagentPermissionPolicy {
  id         String   @id @default(cuid())
  subagentId String
  policyId   String
  priority   Int      @default(100)
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  subagent Subagent         @relation(fields: [subagentId], references: [id], onDelete: Cascade)
  policy   PermissionPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([subagentId, policyId])
  @@index([subagentId, priority])
  @@index([policyId])
}

enum PermissionType {
  bash_command
  tool_command
}

enum PermissionStatus {
  allow
  ask
  deny
}

enum PermissionScope {
  global
  workspace
  user
  subagent
}

model AgentAction {
  id        String   @id @default(cuid())
  sessionId String
  type      ActionType
  action    String
  details   Json?
  status    String?
  result    Json?
  timestamp DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([type])
  @@index([timestamp])
}

enum ActionType {
  slack
  bigquery
  sentry
  other
}

model Hook {
  id        String   @id @default(cuid())
  name      String
  matcher   String
  type      HookType
  command   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  executions HookExecution[]

  @@index([isActive])
}

enum HookType {
  command
  script
}

model HookExecution {
  id        String   @id @default(cuid())
  hookId    String
  sessionId String
  toolUseId String?
  status    String?
  output    String?
  error     String?
  duration  Int?
  timestamp DateTime @default(now())

  hook    Hook    @relation(fields: [hookId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([hookId])
  @@index([sessionId])
  @@index([timestamp])
}

model Task {
  id            String      @id @default(cuid())
  sessionId     String
  name          String
  status        TaskStatus  @default(running)
  duration      Int?
  tokenCount    Int?
  strategy      TaskStrategy?
  permissionMode String?
  metadata      Json?
  startedAt     DateTime    @default(now())
  completedAt   DateTime?

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([status])
}

enum TaskStatus {
  running
  completed
  failed
  thinking
}

enum TaskStrategy {
  background_agent
  stop_hook
  plugin
}

model VerificationRun {
  id          String              @id @default(cuid())
  sessionId   String
  type        VerificationType
  status      String?
  result      Json?
  iterations  Int?
  feedback    String?
  startedAt   DateTime            @default(now())
  completedAt DateTime?

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([type])
}

enum VerificationType {
  browser
  bash
  test_suite
  app_test
}

model AgentDeployment {
  id            String              @id @default(cuid())
  name          String
  description   String?
  subagentId    String?
  nodeId        String
  nodeType      NodeType
  deploymentType DeploymentType     @default(agent)
  deploymentProfile DeploymentProfile @default(local_starship_build)
  provisioningMode ProvisioningMode @default(terraform_ansible)
  nodeUrl       String?
  status        DeploymentStatus    @default(pending)
  config        Json?
  metadata      Json?
  deployedAt    DateTime?
  lastHealthCheck DateTime?
  healthStatus  String?
  userId        String
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  subagent      Subagent?           @relation(fields: [subagentId], references: [id], onDelete: SetNull)
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  bridgeCrew    BridgeCrew[]
  applications  ApplicationDeployment[]
  bridgeCallRounds BridgeCallRound[] @relation("BridgeCallRoundShip")
  bridgeConnections BridgeConnection[]
  bridgeDispatchDeliveries BridgeDispatchDelivery[]

  @@index([nodeId])
  @@index([status])
  @@index([userId])
  @@index([subagentId])
  @@index([deploymentType])
  @@index([deploymentProfile])
}

model BridgeConnection {
  id                 String                   @id @default(cuid())
  deploymentId       String
  provider           BridgeConnectionProvider
  name               String
  destination        String
  enabled            Boolean                  @default(true)
  autoRelay          Boolean                  @default(true)
  config             Json?
  credentials        Json
  lastDeliveryAt     DateTime?
  lastDeliveryStatus BridgeDispatchStatus?
  lastError          String?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt

  deployment         AgentDeployment          @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  deliveries         BridgeDispatchDelivery[]

  @@index([deploymentId])
  @@index([deploymentId, enabled])
  @@index([provider])
  @@index([updatedAt])
}

model BridgeDispatchDelivery {
  id                String               @id @default(cuid())
  deploymentId      String
  connectionId      String
  source            BridgeDispatchSource
  status            BridgeDispatchStatus @default(pending)
  dedupeKey         String               @unique
  message           String
  payload           Json?
  attempts          Int                  @default(0)
  nextAttemptAt     DateTime?
  providerMessageId String?
  result            Json?
  lastError         String?
  deliveredAt       DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  deployment        AgentDeployment      @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  connection        BridgeConnection     @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([deploymentId, createdAt])
  @@index([connectionId, createdAt])
  @@index([status, nextAttemptAt])
  @@index([source, createdAt])
}

enum DeploymentType {
  agent
  ship
}

enum DeploymentProfile {
  local_starship_build
  cloud_shipyard
}

enum ProvisioningMode {
  terraform_ansible
  terraform_only
  ansible_only
}

enum NodeType {
  local
  cloud
  hybrid
}

enum DeploymentStatus {
  pending
  deploying
  active
  inactive
  failed
  updating
}

model BridgeCrew {
  id            String          @id @default(cuid())
  deploymentId  String
  role          BridgeCrewRole
  callsign      String
  name          String
  description   String?
  content       String
  status        BridgeCrewStatus @default(active)
  walletEnabled Boolean         @default(false)
  walletAddress String?
  walletKeyRef  String?
  walletEnclaveUrl String?
  metadata      Json?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  deployment    AgentDeployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  @@unique([deploymentId, role])
  @@index([deploymentId])
  @@index([walletEnabled])
  @@index([walletKeyRef])
}

enum BridgeCrewRole {
  xo
  ops
  eng
  sec
  med
  cou
}

enum BridgeCrewStatus {
  active
  inactive
}

enum BridgeConnectionProvider {
  telegram
  discord
  whatsapp
}

enum BridgeDispatchSource {
  cou_auto
  manual
  test
}

enum BridgeDispatchStatus {
  pending
  processing
  completed
  failed
}

model ApplicationDeployment {
  id            String              @id @default(cuid())
  name          String
  description   String?
  applicationType ApplicationType
  image         String?
  repository    String?
  branch        String?
  buildCommand  String?
  startCommand  String?
  port          Int?
  environment   Json?
  shipDeploymentId String
  nodeId        String
  nodeType      NodeType
  deploymentProfile DeploymentProfile @default(local_starship_build)
  provisioningMode ProvisioningMode @default(terraform_ansible)
  nodeUrl       String?
  status        DeploymentStatus    @default(pending)
  config        Json?
  metadata      Json?
  deployedAt    DateTime?
  lastHealthCheck DateTime?
  healthStatus  String?
  version       String?
  userId        String
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  shipDeployment AgentDeployment     @relation(fields: [shipDeploymentId], references: [id], onDelete: Cascade)
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([shipDeploymentId])
  @@index([nodeId])
  @@index([status])
  @@index([userId])
  @@index([applicationType])
  @@index([deploymentProfile])
}

enum ApplicationType {
  docker
  nodejs
  python
  static
  custom
}

model Project {
  id            String        @id @default(cuid())
  name          String
  description   String?
  slug          String        @unique
  isPublic      Boolean       @default(false)
  tags          String[]
  repository    String?
  website       String?
  readme        String?
  thumbnail     String?
  category      ProjectCategory?
  stars         Int           @default(0)
  views         Int           @default(0)
  userId        String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isPublic])
  @@index([slug])
  @@index([category])
}

enum ProjectCategory {
  ai_agent
  automation
  tool
  library
  application
  other
}

model NodeSource {
  id         String   @id @default(cuid())
  nodeId     String   @unique
  name       String?
  nodeType   NodeType?
  nodeUrl    String?
  apiKeyHash String
  isActive   Boolean  @default(true)
  lastSeenAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  events          ForwardingEvent[]
  nonces          ForwardingNonce[]
  sourceConfigs   ForwardingConfig[] @relation("ForwardingConfigSource")
}

model ForwardingEvent {
  id          String               @id @default(cuid())
  sourceNodeId String
  dedupeKey   String               @unique
  eventType   ForwardingEventType
  payload     Json
  metadata    Json?
  occurredAt  DateTime
  receivedAt  DateTime             @default(now())
  status      ForwardingEventStatus @default(received)

  sourceNode NodeSource @relation(fields: [sourceNodeId], references: [id], onDelete: Cascade)

  @@index([sourceNodeId])
  @@index([eventType])
  @@index([occurredAt])
  @@index([status])
}

model ForwardingNonce {
  id          String   @id @default(cuid())
  sourceNodeId String
  nonce       String
  timestamp   DateTime
  createdAt   DateTime @default(now())

  sourceNode NodeSource @relation(fields: [sourceNodeId], references: [id], onDelete: Cascade)

  @@unique([sourceNodeId, nonce])
  @@index([timestamp])
}

model ForwardingConfig {
  id          String               @id @default(cuid())
  userId      String
  sourceNodeId String?
  targetUrl   String
  targetApiKey String?
  enabled     Boolean              @default(false)
  eventTypes  ForwardingEventType[]
  status      ForwardingTargetStatus @default(paused)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceNode NodeSource? @relation("ForwardingConfigSource", fields: [sourceNodeId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([enabled])
}

model ObservabilityTrace {
  id        String   @id @default(cuid())
  traceId   String   @unique
  userId    String?
  sessionId String?
  source    String?
  status    String?
  payload   Json
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User?                            @relation(fields: [userId], references: [id], onDelete: SetNull)
  session       Session?                         @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  decryptAudits ObservabilityTraceDecryptAudit[]

  @@index([userId, createdAt])
  @@index([sessionId, createdAt])
  @@index([createdAt])
}

model ObservabilityTraceDecryptAudit {
  id        String   @id @default(cuid())
  traceId   String
  actorType String
  actorId   String
  actorEmail String?
  createdAt DateTime @default(now())

  trace     ObservabilityTrace @relation(fields: [traceId], references: [id], onDelete: Cascade)
  @@index([traceId, createdAt])
  @@index([actorType, createdAt])
}

enum ForwardingEventType {
  session
  task
  command_execution
  verification
  action
  deployment
  application
  bridge_station
  system_status
}

enum ForwardingEventStatus {
  received
  projected
  duplicate
  rejected
}

enum ForwardingTargetStatus {
  active
  paused
  failed
}

model GitHubWebhookEvent {
  id                String   @id @default(cuid())
  eventType         String
  action            String?
  repository        String?
  pullRequestNumber Int?
  commentId         Int?
  commentBody       String?
  payload           Json
  status            String   @default("received")
  responseBody      Json?
  error             String?
  createdAt         DateTime @default(now())
  processedAt       DateTime?

  @@index([eventType])
  @@index([action])
  @@index([repository])
  @@index([createdAt])
}

model ShipTopology {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String
  teamId      String?  @default("uss-k8s")

  components  Json
  edges       Json
  positions   Json?
  hierarchy   Json?

  isDefault   Boolean  @default(false)
  version     Int      @default(1)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([teamId])
  @@index([isDefault])
}
