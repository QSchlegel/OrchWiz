// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  emailVerified Boolean @default(false)
  isAnonymous Boolean @default(false)
  name      String?
  githubId  String?  @unique
  avatarUrl String?
  role      UserRole @default(captain)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions         Session[]
  authSessions     AuthSession[]
  accounts         Account[]
  passkeys         Passkey[]
  commandExecutions CommandExecution[]
  guidanceRevisions GuidanceRevision[]
  agentDeployments  AgentDeployment[]
  applicationDeployments ApplicationDeployment[]
  projects              Project[]
  forwardingConfigs     ForwardingConfig[]
  shipTopologies        ShipTopology[]
  bridgeThreads         BridgeThread[]       @relation("BridgeThreadUser")
  bridgeCallRounds      BridgeCallRound[]
  observabilityTraces   ObservabilityTrace[]
  agentSyncPreference   AgentSyncPreference?
  agentSyncSignals      AgentSyncSignal[]
  agentSyncRuns         AgentSyncRun[]
  agentSyncSuggestions  AgentSyncSuggestion[]
  ownedCommands         Command[]             @relation("CommandOwner")
  ownedHooks            Hook[]                @relation("HookOwner")
  ownedSubagents        Subagent[]            @relation("SubagentOwner")
  ownedPermissions      Permission[]          @relation("PermissionOwner")
  ownedPermissionPolicies PermissionPolicy[]  @relation("PermissionPolicyOwner")
  ownedNodeSources      NodeSource[]          @relation("NodeSourceOwner")
  skillCatalogEntries   SkillCatalogEntry[]
  skillImportRuns       SkillImportRun[]
  toolCatalogEntries    ToolCatalogEntry[]
  toolImportRuns        ToolImportRun[]
  shipToolGrants        ShipToolGrant[]       @relation("ToolGrantOwner")
  grantedShipToolGrants ShipToolGrant[]       @relation("ToolGrantGrantedBy")
  shipToolAccessRequestsOwned ShipToolAccessRequest[] @relation("ToolAccessRequestOwner")
  shipToolAccessRequestsRequested ShipToolAccessRequest[] @relation("ToolAccessRequestRequestedBy")
  shipToolAccessRequestsReviewed ShipToolAccessRequest[] @relation("ToolAccessRequestReviewedBy")
  shipyardSecretTemplates ShipyardSecretTemplate[]
  shipyardCloudCredentials ShipyardCloudCredential[]
  shipyardCloudSshKeys   ShipyardCloudSshKey[]
  shipyardSshTunnels     ShipyardSshTunnel[]
  shipyardBillingWallet  ShipyardBillingWallet?
  shipyardBillingTopups  ShipyardBillingTopup[]
  shipyardBillingLedgerEntries ShipyardBillingLedgerEntry[]
  newsletterSubscriptions NewsletterSubscription[]
  userMemorySigner      UserMemorySigner?
  ragPerformanceSamples RagPerformanceSample[]
  runtimePerformanceSamples RuntimePerformanceSample[]
}

enum UserRole {
  captain
  admin
}

model AuthSession {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Account {
  id           String   @id @default(cuid())
  accountId    String
  providerId   String
  userId       String
  accessToken  String?
  refreshToken String?
  idToken      String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope        String?
  password     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([providerId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@index([identifier])
}

model Passkey {
  id           String   @id @default(cuid())
  name         String?
  publicKey    String
  userId       String
  credentialID String   @unique
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  createdAt    DateTime? @default(now())
  aaguid       String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Session {
  id             String   @id @default(uuid())
  title          String?
  description    String?
  prompt         String?
  status         SessionStatus @default(planning)
  mode           SessionMode @default(plan)
  source         SessionSource @default(web)
  projectName    String?
  branch         String?
  environment    String?
  userId         String
  parentSessionId String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  completedAt    DateTime?

  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentSession     Session?             @relation("SessionFork", fields: [parentSessionId], references: [id])
  childSessions     Session[]            @relation("SessionFork")
  interactions      SessionInteraction[]
  commandExecutions CommandExecution[]
  agentActions      AgentAction[]
  hooks             HookExecution[]
  tasks             Task[]
  verificationRuns  VerificationRun[]
  bridgeThread      BridgeThread?            @relation("BridgeThreadSession")
  bridgeMirrorJobs  BridgeMirrorJob[]        @relation("BridgeMirrorJobSession")
  observabilityTraces ObservabilityTrace[]
  bridgeAgentChatMembers BridgeAgentChatMember[] @relation("BridgeAgentChatMemberSession")
  bridgeAgentChatReplyJobs BridgeAgentChatReplyJob[] @relation("BridgeAgentChatReplyRecipientSession")
  ragPerformanceSamples RagPerformanceSample[]
  runtimePerformanceSamples RuntimePerformanceSample[]
}

enum SessionStatus {
  planning
  executing
  completed
  paused
  failed
}

enum SessionMode {
  plan
  auto_accept
}

enum SessionSource {
  local
  web
  ios
  terminal_handoff
}

model SessionInteraction {
  id        String   @id @default(cuid())
  sessionId String
  type      InteractionType
  content   String
  metadata  Json?
  timestamp DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  bridgeMirrorLink BridgeMirrorLink?
  bridgeMirrorJobs BridgeMirrorJob[] @relation("BridgeMirrorJobInteraction")

  @@index([sessionId])
  @@index([timestamp])
}

enum InteractionType {
  user_input
  ai_response
  tool_use
  error
}

enum BridgeChatRole {
  user
  assistant
  system
}

enum BridgeMirrorDirection {
  thread_to_session
  session_to_thread
}

enum BridgeMirrorJobStatus {
  pending
  processing
  completed
  failed
}

enum BridgeAgentChatRoomType {
  dm
  group
}

enum BridgeAgentChatMessageKind {
  agent
  system
}

enum BridgeAgentChatReplyJobStatus {
  pending
  processing
  completed
  failed
}

model BridgeThread {
  id         String         @id @default(uuid())
  title      String
  userId     String?
  stationKey BridgeCrewRole?
  sessionId  String?        @unique
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  user       User?          @relation("BridgeThreadUser", fields: [userId], references: [id], onDelete: SetNull)
  session    Session?       @relation("BridgeThreadSession", fields: [sessionId], references: [id], onDelete: SetNull)
  messages   BridgeMessage[]
  mirrorJobs BridgeMirrorJob[]

  @@unique([userId, stationKey])
  @@index([userId])
  @@index([stationKey])
  @@index([updatedAt])
}

model BridgeMessage {
  id         String           @id @default(uuid())
  threadId   String
  role       BridgeChatRole
  content    String
  createdAt  DateTime         @default(now())

  thread      BridgeThread    @relation(fields: [threadId], references: [id], onDelete: Cascade)
  mirrorLink  BridgeMirrorLink?
  mirrorJobs  BridgeMirrorJob[]

  @@index([threadId, createdAt])
  @@index([createdAt])
}

model BridgeMirrorLink {
  id            String             @id @default(cuid())
  messageId     String             @unique
  interactionId String             @unique
  createdAt     DateTime           @default(now())

  message       BridgeMessage      @relation(fields: [messageId], references: [id], onDelete: Cascade)
  interaction   SessionInteraction @relation(fields: [interactionId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}

model BridgeMirrorJob {
  id            String               @id @default(cuid())
  dedupeKey     String               @unique
  direction     BridgeMirrorDirection
  status        BridgeMirrorJobStatus @default(pending)
  attempts      Int                  @default(0)
  nextAttemptAt DateTime?
  lastError     String?
  threadId      String?
  sessionId     String?
  messageId     String?
  interactionId String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  thread        BridgeThread?        @relation(fields: [threadId], references: [id], onDelete: SetNull)
  session       Session?             @relation("BridgeMirrorJobSession", fields: [sessionId], references: [id], onDelete: SetNull)
  message       BridgeMessage?       @relation(fields: [messageId], references: [id], onDelete: SetNull)
  interaction   SessionInteraction?  @relation("BridgeMirrorJobInteraction", fields: [interactionId], references: [id], onDelete: SetNull)

  @@index([status, nextAttemptAt])
  @@index([direction])
  @@index([threadId])
  @@index([sessionId])
  @@index([messageId])
  @@index([interactionId])
  @@index([createdAt])
}

model BridgeAgentChatRoom {
  id                    String                    @id @default(uuid())
  shipDeploymentId      String
  roomType              BridgeAgentChatRoomType
  title                 String
  dmKey                 String?                   @unique
  createdByBridgeCrewId String?
  metadata              Json?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt

  shipDeployment        AgentDeployment           @relation(fields: [shipDeploymentId], references: [id], onDelete: Cascade)
  createdByBridgeCrew   BridgeCrew?               @relation("BridgeAgentChatRoomCreator", fields: [createdByBridgeCrewId], references: [id], onDelete: SetNull)
  members               BridgeAgentChatMember[]
  messages              BridgeAgentChatMessage[]
  replyJobs             BridgeAgentChatReplyJob[]

  @@index([shipDeploymentId, updatedAt])
  @@index([shipDeploymentId, roomType])
  @@index([createdByBridgeCrewId])
}

model BridgeAgentChatMember {
  id           String              @id @default(cuid())
  roomId       String
  bridgeCrewId String
  sessionId    String
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  room         BridgeAgentChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  bridgeCrew   BridgeCrew          @relation(fields: [bridgeCrewId], references: [id], onDelete: Cascade)
  session      Session             @relation("BridgeAgentChatMemberSession", fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([roomId, bridgeCrewId])
  @@unique([roomId, sessionId])
  @@index([bridgeCrewId])
  @@index([sessionId])
}

model BridgeAgentChatMessage {
  id               String                     @id @default(uuid())
  roomId           String
  kind             BridgeAgentChatMessageKind @default(agent)
  senderBridgeCrewId String?
  content          String
  inReplyToMessageId String?
  metadata         Json?
  createdAt        DateTime                   @default(now())

  room             BridgeAgentChatRoom        @relation(fields: [roomId], references: [id], onDelete: Cascade)
  senderBridgeCrew BridgeCrew?                @relation("BridgeAgentChatMessageSender", fields: [senderBridgeCrewId], references: [id], onDelete: SetNull)
  inReplyToMessage BridgeAgentChatMessage?    @relation("BridgeAgentChatMessageReplyChain", fields: [inReplyToMessageId], references: [id], onDelete: SetNull)
  replyMessages    BridgeAgentChatMessage[]   @relation("BridgeAgentChatMessageReplyChain")
  sourceReplyJobs  BridgeAgentChatReplyJob[]  @relation("BridgeAgentChatReplySourceMessage")
  outputReplyJobs  BridgeAgentChatReplyJob[]  @relation("BridgeAgentChatReplyOutputMessage")

  @@index([roomId, createdAt])
  @@index([senderBridgeCrewId, createdAt])
  @@index([inReplyToMessageId])
  @@index([createdAt])
}

model BridgeAgentChatReplyJob {
  id                    String                       @id @default(cuid())
  dedupeKey             String                       @unique
  shipDeploymentId      String
  roomId                String
  sourceMessageId       String
  recipientBridgeCrewId String
  recipientSessionId    String
  status                BridgeAgentChatReplyJobStatus @default(pending)
  attempts              Int                          @default(0)
  nextAttemptAt         DateTime?
  lastError             String?
  outputMessageId       String?
  createdAt             DateTime                     @default(now())
  updatedAt             DateTime                     @updatedAt
  completedAt           DateTime?

  shipDeployment        AgentDeployment              @relation(fields: [shipDeploymentId], references: [id], onDelete: Cascade)
  room                  BridgeAgentChatRoom          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sourceMessage         BridgeAgentChatMessage       @relation("BridgeAgentChatReplySourceMessage", fields: [sourceMessageId], references: [id], onDelete: Cascade)
  recipientBridgeCrew   BridgeCrew                   @relation("BridgeAgentChatReplyRecipient", fields: [recipientBridgeCrewId], references: [id], onDelete: Cascade)
  recipientSession      Session                      @relation("BridgeAgentChatReplyRecipientSession", fields: [recipientSessionId], references: [id], onDelete: Cascade)
  outputMessage         BridgeAgentChatMessage?      @relation("BridgeAgentChatReplyOutputMessage", fields: [outputMessageId], references: [id], onDelete: SetNull)

  @@index([status, nextAttemptAt])
  @@index([shipDeploymentId, createdAt])
  @@index([roomId, createdAt])
  @@index([sourceMessageId])
  @@index([recipientBridgeCrewId])
  @@index([recipientSessionId])
  @@index([outputMessageId])
  @@index([createdAt])
}

enum BridgeCallRoundSource {
  operator
  system
}

enum BridgeCallRoundStatus {
  pending
  running
  completed
  partial
  failed
}

enum BridgeCallOfficerResultStatus {
  success
  offline
  failed
}

model BridgeCallRound {
  id               String                        @id @default(cuid())
  userId           String
  shipDeploymentId String?
  directive        String
  source           BridgeCallRoundSource         @default(operator)
  status           BridgeCallRoundStatus         @default(pending)
  leadStationKey   BridgeCrewRole?
  summary          String?
  metadata         Json?
  createdAt        DateTime                      @default(now())
  completedAt      DateTime?

  user             User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  shipDeployment   AgentDeployment?              @relation("BridgeCallRoundShip", fields: [shipDeploymentId], references: [id], onDelete: SetNull)
  officerResults   BridgeCallOfficerResult[]

  @@index([userId, createdAt])
  @@index([userId, shipDeploymentId, createdAt])
  @@index([shipDeploymentId])
}

model BridgeCallOfficerResult {
  id                String                       @id @default(cuid())
  roundId           String
  stationKey        BridgeCrewRole
  callsign          String
  status            BridgeCallOfficerResultStatus
  wasRetried        Boolean                      @default(false)
  attemptCount      Int                          @default(1)
  error             String?
  summary           String?
  threadId          String?
  sessionId         String?
  userInteractionId String?
  aiInteractionId   String?
  provider          String?
  fallbackUsed      Boolean?
  latencyMs         Int?
  createdAt         DateTime                     @default(now())

  round             BridgeCallRound              @relation(fields: [roundId], references: [id], onDelete: Cascade)

  @@unique([roundId, stationKey])
  @@index([roundId])
  @@index([stationKey])
  @@index([status])
}

model Command {
  id            String   @id @default(cuid())
  name          String
  description   String?
  scriptContent String
  path          String?
  isShared      Boolean  @default(false)
  teamId        String?
  ownerUserId   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  executions CommandExecution[]
  owner      User?              @relation("CommandOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  @@unique([name, teamId])
  @@index([teamId])
  @@index([ownerUserId])
}

model CommandExecution {
  id          String   @id @default(cuid())
  commandId   String
  sessionId   String?
  subagentId  String?
  userId      String
  status      ExecutionStatus @default(running)
  output      String?
  error       String?
  duration    Int?
  startedAt   DateTime @default(now())
  completedAt DateTime?

  command Command @relation(fields: [commandId], references: [id], onDelete: Cascade)
  session Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  subagent Subagent? @relation(fields: [subagentId], references: [id], onDelete: SetNull)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([commandId])
  @@index([sessionId])
  @@index([subagentId])
  @@index([userId])
}

enum ExecutionStatus {
  running
  completed
  failed
}

enum SubagentType {
  general
  bridge_crew
  exocomp
}

model Subagent {
  id          String   @id @default(cuid())
  name        String
  subagentType SubagentType @default(general)
  description String?
  content     String
  path        String?
  settings    Json?
  isShared    Boolean  @default(false)
  teamId      String?
  ownerUserId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  deployments AgentDeployment[]
  permissions Permission[]
  permissionPolicies SubagentPermissionPolicy[]
  commandExecutions CommandExecution[]
  agentSyncSignals AgentSyncSignal[]
  agentSyncRuns AgentSyncRun[]
  agentSyncSuggestions AgentSyncSuggestion[]
  owner User? @relation("SubagentOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  @@unique([name, teamId])
  @@index([teamId])
  @@index([ownerUserId])
  @@index([subagentType])
}

model AgentSyncPreference {
  id           String   @id @default(cuid())
  userId       String   @unique
  timezone     String   @default("UTC")
  nightlyEnabled Boolean @default(true)
  nightlyHour  Int      @default(2)
  lastNightlyRunAt DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AgentSyncSignal {
  id          String              @id @default(cuid())
  userId      String
  subagentId  String
  source      AgentSyncSignalSource
  sourceId    String
  reward      Float
  details     Json?
  occurredAt  DateTime
  createdAt   DateTime            @default(now())

  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  subagent    Subagent            @relation(fields: [subagentId], references: [id], onDelete: Cascade)

  @@unique([source, sourceId, subagentId])
  @@index([userId, occurredAt])
  @@index([subagentId, occurredAt])
  @@index([source, occurredAt])
}

model AgentSyncRun {
  id            String                 @id @default(cuid())
  userId        String
  subagentId    String?
  trigger       AgentSyncTrigger
  scope         AgentSyncScope
  status        AgentSyncRunStatus     @default(pending)
  summary       String?
  error         String?
  fileSyncStatus AgentSyncFileSyncStatus @default(skipped)
  metadata      Json?
  startedAt     DateTime               @default(now())
  completedAt   DateTime?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  subagent      Subagent?              @relation(fields: [subagentId], references: [id], onDelete: SetNull)
  suggestions   AgentSyncSuggestion[]

  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([subagentId, createdAt])
}

model AgentSyncSuggestion {
  id             String                   @id @default(cuid())
  runId          String
  userId         String
  subagentId     String
  fileName       String
  risk           AgentSyncSuggestionRisk
  status         AgentSyncSuggestionStatus @default(proposed)
  reason         String?
  fileSyncStatus AgentSyncFileSyncStatus   @default(skipped)
  existingContent String?
  suggestedContent String
  metadata       Json?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  appliedAt      DateTime?

  run            AgentSyncRun              @relation(fields: [runId], references: [id], onDelete: Cascade)
  user           User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  subagent       Subagent                  @relation(fields: [subagentId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([subagentId, createdAt])
  @@index([status, createdAt])
}

enum AgentSyncTrigger {
  manual
  nightly
}

enum AgentSyncScope {
  selected_agent
  bridge_crew
}

enum AgentSyncRunStatus {
  pending
  running
  completed
  failed
}

enum AgentSyncSignalSource {
  command
  verification
  bridge_call
}

enum AgentSyncSuggestionRisk {
  low
  high
}

enum AgentSyncSuggestionStatus {
  proposed
  applied
  rejected
  failed
}

enum AgentSyncFileSyncStatus {
  synced
  filesystem_sync_failed
  skipped
}

model ClaudeDocument {
  id          String   @id @default(cuid())
  teamId      String?
  title       String
  content     String
  version     Int      @default(1)
  lastUpdated DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  guidanceEntries GuidanceEntry[]

  @@index([teamId])
}

model GuidanceEntry {
  id          String            @id @default(cuid())
  documentId  String
  content     String
  category    String?
  status      GuidanceStatus   @default(active)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  document   ClaudeDocument    @relation(fields: [documentId], references: [id], onDelete: Cascade)
  revisions  GuidanceRevision[]

  @@index([documentId])
  @@index([status])
}

enum GuidanceStatus {
  active
  deprecated
}

model GuidanceRevision {
  id              String   @id @default(cuid())
  guidanceEntryId String
  oldContent      String?
  newContent      String?
  diff            String?
  triggeredBy     String?
  commitHash      String?
  prLink          String?
  botResponse     String?
  timestamp       DateTime @default(now())

  guidanceEntry GuidanceEntry @relation(fields: [guidanceEntryId], references: [id], onDelete: Cascade)
  user          User?         @relation(fields: [triggeredBy], references: [id], onDelete: SetNull)

  @@index([guidanceEntryId])
  @@index([timestamp])
}

model Permission {
  id            String          @id @default(cuid())
  commandPattern String
  type         PermissionType
  status       PermissionStatus
  scope        PermissionScope
  subagentId   String?
  sourceFile   String?
  isShared     Boolean         @default(false)
  ownerUserId  String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  subagent     Subagent?       @relation(fields: [subagentId], references: [id], onDelete: SetNull)
  owner        User?           @relation("PermissionOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  @@index([commandPattern])
  @@index([scope])
  @@index([subagentId])
  @@index([ownerUserId])
}

model PermissionPolicy {
  id          String                  @id @default(cuid())
  slug        String                  @unique
  name        String
  description String?
  isSystem    Boolean                 @default(false)
  ownerUserId String?
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  rules       PermissionPolicyRule[]
  assignments SubagentPermissionPolicy[]
  owner       User?                   @relation("PermissionPolicyOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  @@index([ownerUserId])
}

model PermissionPolicyRule {
  id             String            @id @default(cuid())
  policyId       String
  commandPattern String
  type           PermissionType
  status         PermissionStatus
  sortOrder      Int               @default(0)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  policy PermissionPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@index([policyId])
  @@index([policyId, sortOrder])
}

model SubagentPermissionPolicy {
  id         String   @id @default(cuid())
  subagentId String
  policyId   String
  priority   Int      @default(100)
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  subagent Subagent         @relation(fields: [subagentId], references: [id], onDelete: Cascade)
  policy   PermissionPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([subagentId, policyId])
  @@index([subagentId, priority])
  @@index([policyId])
}

enum PermissionType {
  bash_command
  tool_command
}

enum PermissionStatus {
  allow
  ask
  deny
}

enum PermissionScope {
  global
  workspace
  user
  subagent
}

enum SkillCatalogSource {
  curated
  experimental
  custom_github
  local
  system
}

enum SkillImportStatus {
  running
  succeeded
  failed
}

enum ToolCatalogSource {
  curated
  custom_github
  local
  system
}

enum ToolImportStatus {
  running
  succeeded
  failed
}

enum ShipToolGrantScope {
  ship
  bridge_crew
}

enum ShipToolAccessRequestStatus {
  pending
  approved
  denied
}

enum ShipToolRequestScopePreference {
  requester_only
  ship
}

model SkillCatalogEntry {
  id           String           @id @default(cuid())
  ownerUserId  String
  slug         String
  name         String
  description  String?
  source       SkillCatalogSource
  sourceKey    String
  repo         String?
  sourcePath   String?
  sourceRef    String?
  sourceUrl    String?
  isInstalled  Boolean          @default(false)
  isSystem     Boolean          @default(false)
  installedPath String?
  metadata     Json?
  lastSyncedAt DateTime         @default(now())
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  owner       User             @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  importRuns  SkillImportRun[]

  @@unique([ownerUserId, sourceKey])
  @@index([ownerUserId, source])
  @@index([ownerUserId, isInstalled])
  @@index([ownerUserId, slug])
  @@index([ownerUserId, updatedAt])
}

model SkillImportRun {
  id            String            @id @default(cuid())
  ownerUserId   String
  catalogEntryId String?
  mode          String
  source        SkillCatalogSource?
  skillSlug     String?
  repo          String?
  sourcePath    String?
  sourceRef     String?
  sourceUrl     String?
  status        SkillImportStatus @default(running)
  exitCode      Int?
  stdout        String?
  stderr        String?
  errorMessage  String?
  startedAt     DateTime          @default(now())
  completedAt   DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  owner        User              @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  catalogEntry SkillCatalogEntry? @relation(fields: [catalogEntryId], references: [id], onDelete: SetNull)

  @@index([ownerUserId, createdAt(sort: Desc)])
  @@index([ownerUserId, status, createdAt(sort: Desc)])
  @@index([catalogEntryId])
}

model ToolCatalogEntry {
  id            String            @id @default(cuid())
  ownerUserId   String
  slug          String
  name          String
  description   String?
  source        ToolCatalogSource
  sourceKey     String
  repo          String?
  sourcePath    String?
  sourceRef     String?
  sourceUrl     String?
  isInstalled   Boolean           @default(false)
  isSystem      Boolean           @default(false)
  installedPath String?
  metadata      Json?
  lastSyncedAt  DateTime          @default(now())
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  owner         User              @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  importRuns    ToolImportRun[]
  shipGrants    ShipToolGrant[]
  accessRequests ShipToolAccessRequest[]

  @@unique([ownerUserId, sourceKey])
  @@index([ownerUserId, source])
  @@index([ownerUserId, isInstalled])
  @@index([ownerUserId, slug])
  @@index([ownerUserId, updatedAt])
}

model ToolImportRun {
  id            String           @id @default(cuid())
  ownerUserId   String
  catalogEntryId String?
  mode          String
  source        ToolCatalogSource?
  toolSlug      String?
  repo          String?
  sourcePath    String?
  sourceRef     String?
  sourceUrl     String?
  status        ToolImportStatus @default(running)
  exitCode      Int?
  stdout        String?
  stderr        String?
  errorMessage  String?
  startedAt     DateTime         @default(now())
  completedAt   DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  owner         User             @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  catalogEntry  ToolCatalogEntry? @relation(fields: [catalogEntryId], references: [id], onDelete: SetNull)

  @@index([ownerUserId, createdAt(sort: Desc)])
  @@index([ownerUserId, status, createdAt(sort: Desc)])
  @@index([catalogEntryId])
}

model ShipToolGrant {
  id             String           @id @default(cuid())
  ownerUserId    String
  shipDeploymentId String
  catalogEntryId String
  scope          ShipToolGrantScope
  scopeKey       String
  bridgeCrewId   String?
  grantedByUserId String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  owner          User             @relation("ToolGrantOwner", fields: [ownerUserId], references: [id], onDelete: Cascade)
  shipDeployment AgentDeployment  @relation(fields: [shipDeploymentId], references: [id], onDelete: Cascade)
  catalogEntry   ToolCatalogEntry @relation(fields: [catalogEntryId], references: [id], onDelete: Cascade)
  bridgeCrew     BridgeCrew?      @relation("ShipToolGrantBridgeCrew", fields: [bridgeCrewId], references: [id], onDelete: SetNull)
  grantedBy      User?            @relation("ToolGrantGrantedBy", fields: [grantedByUserId], references: [id], onDelete: SetNull)
  approvedRequests ShipToolAccessRequest[] @relation("ShipToolAccessRequestApprovedGrant")

  @@unique([shipDeploymentId, catalogEntryId, scopeKey])
  @@index([ownerUserId, shipDeploymentId, scope])
  @@index([bridgeCrewId])
  @@index([catalogEntryId])
}

model ShipToolAccessRequest {
  id                String                        @id @default(cuid())
  ownerUserId       String
  shipDeploymentId  String
  catalogEntryId    String
  requesterBridgeCrewId String?
  requestedByUserId String
  scopePreference   ShipToolRequestScopePreference @default(requester_only)
  status            ShipToolAccessRequestStatus   @default(pending)
  rationale         String?
  metadata          Json?
  approvedGrantId   String?
  reviewedByUserId  String?
  reviewedAt        DateTime?
  createdAt         DateTime                      @default(now())
  updatedAt         DateTime                      @updatedAt

  owner             User                          @relation("ToolAccessRequestOwner", fields: [ownerUserId], references: [id], onDelete: Cascade)
  shipDeployment    AgentDeployment               @relation(fields: [shipDeploymentId], references: [id], onDelete: Cascade)
  catalogEntry      ToolCatalogEntry              @relation(fields: [catalogEntryId], references: [id], onDelete: Cascade)
  requesterBridgeCrew BridgeCrew?                 @relation("ShipToolAccessRequestRequesterBridgeCrew", fields: [requesterBridgeCrewId], references: [id], onDelete: SetNull)
  requestedBy       User                          @relation("ToolAccessRequestRequestedBy", fields: [requestedByUserId], references: [id], onDelete: Cascade)
  reviewedBy        User?                         @relation("ToolAccessRequestReviewedBy", fields: [reviewedByUserId], references: [id], onDelete: SetNull)
  approvedGrant     ShipToolGrant?                @relation("ShipToolAccessRequestApprovedGrant", fields: [approvedGrantId], references: [id], onDelete: SetNull)

  @@index([ownerUserId, shipDeploymentId, status, createdAt(sort: Desc)])
  @@index([requesterBridgeCrewId])
  @@index([catalogEntryId])
  @@index([approvedGrantId])
}

model AgentAction {
  id        String   @id @default(cuid())
  sessionId String
  type      ActionType
  action    String
  details   Json?
  status    String?
  result    Json?
  timestamp DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([type])
  @@index([timestamp])
}

enum ActionType {
  slack
  bigquery
  sentry
  other
}

model Hook {
  id        String   @id @default(cuid())
  name      String
  matcher   String
  type      HookType
  command   String
  ownerUserId String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  executions HookExecution[]
  owner      User?           @relation("HookOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  @@index([isActive])
  @@index([ownerUserId])
}

enum HookType {
  command
  script
  webhook
}

model HookExecution {
  id        String   @id @default(cuid())
  hookId    String
  sessionId String?
  toolUseId String?
  status    String?
  output    String?
  error     String?
  duration  Int?
  timestamp DateTime @default(now())

  hook    Hook    @relation(fields: [hookId], references: [id], onDelete: Cascade)
  session Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([hookId])
  @@index([sessionId])
  @@index([timestamp])
}

model Task {
  id            String      @id @default(cuid())
  sessionId     String
  name          String
  status        TaskStatus  @default(running)
  duration      Int?
  tokenCount    Int?
  strategy      TaskStrategy?
  permissionMode String?
  metadata      Json?
  startedAt     DateTime    @default(now())
  completedAt   DateTime?

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([status])
}

enum TaskStatus {
  running
  completed
  failed
  thinking
}

enum TaskStrategy {
  background_agent
  stop_hook
  plugin
}

model VerificationRun {
  id          String              @id @default(cuid())
  sessionId   String
  type        VerificationType
  status      String?
  result      Json?
  iterations  Int?
  feedback    String?
  startedAt   DateTime            @default(now())
  completedAt DateTime?

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([type])
}

enum VerificationType {
  browser
  bash
  test_suite
  app_test
}

model AgentDeployment {
  id            String              @id @default(cuid())
  name          String
  description   String?
  subagentId    String?
  nodeId        String
  nodeType      NodeType
  deploymentType DeploymentType     @default(agent)
  deploymentProfile DeploymentProfile @default(local_starship_build)
  provisioningMode ProvisioningMode @default(terraform_ansible)
  nodeUrl       String?
  status        DeploymentStatus    @default(pending)
  config        Json?
  metadata      Json?
  deployedAt    DateTime?
  lastHealthCheck DateTime?
  healthStatus  String?
  userId        String
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  subagent      Subagent?           @relation(fields: [subagentId], references: [id], onDelete: SetNull)
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  bridgeCrew    BridgeCrew[]
  applications  ApplicationDeployment[]
  bridgeCallRounds BridgeCallRound[] @relation("BridgeCallRoundShip")
  bridgeConnections BridgeConnection[]
  bridgeDispatchDeliveries BridgeDispatchDelivery[]
  shipyardSshTunnels ShipyardSshTunnel[]
  bridgeAgentChatRooms BridgeAgentChatRoom[]
  bridgeAgentChatReplyJobs BridgeAgentChatReplyJob[]
  shipToolGrants ShipToolGrant[]
  shipToolAccessRequests ShipToolAccessRequest[]
  ragPerformanceSamples RagPerformanceSample[] @relation("RagPerformanceSampleShipDeployment")

  @@index([nodeId])
  @@index([status])
  @@index([userId])
  @@index([subagentId])
  @@index([deploymentType])
  @@index([deploymentProfile])
}

model BridgeConnection {
  id                 String                   @id @default(cuid())
  deploymentId       String
  provider           BridgeConnectionProvider
  name               String
  destination        String
  enabled            Boolean                  @default(true)
  autoRelay          Boolean                  @default(true)
  config             Json?
  credentials        Json
  lastDeliveryAt     DateTime?
  lastDeliveryStatus BridgeDispatchStatus?
  lastError          String?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt

  deployment         AgentDeployment          @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  deliveries         BridgeDispatchDelivery[]

  @@index([deploymentId])
  @@index([deploymentId, enabled])
  @@index([provider])
  @@index([updatedAt])
}

model ShipyardSecretTemplate {
  id                String            @id @default(cuid())
  userId            String
  deploymentProfile DeploymentProfile
  secrets           Json
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deploymentProfile])
  @@index([userId])
}

model ShipyardCloudCredential {
  id             String        @id @default(cuid())
  userId         String
  provider       CloudProvider
  tokenEnvelope  Json
  metadata       Json?
  lastValidatedAt DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@index([provider])
}

model ShipyardCloudSshKey {
  id                String        @id @default(cuid())
  userId            String
  provider          CloudProvider
  name              String
  publicKey         String
  fingerprint       String
  privateKeyEnvelope Json
  metadata          Json?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tunnels           ShipyardSshTunnel[]

  @@index([userId, provider])
  @@index([fingerprint])
  @@index([name])
}

model ShipyardSshTunnel {
  id               String             @id @default(cuid())
  userId           String
  deploymentId     String?
  provider         CloudProvider
  name             String
  status           ShipyardTunnelStatus @default(stopped)
  localHost        String             @default("127.0.0.1")
  localPort        Int
  remoteHost       String
  remotePort       Int
  sshHost          String
  sshPort          Int                @default(22)
  sshUser          String             @default("root")
  sshKeyId         String?
  pid              Int?
  pidFile          String?
  controlSocket    String?
  keyFilePath      String?
  lastHealthCheck  DateTime?
  lastError        String?
  metadata         Json?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  deployment       AgentDeployment?   @relation(fields: [deploymentId], references: [id], onDelete: SetNull)
  sshKey           ShipyardCloudSshKey? @relation(fields: [sshKeyId], references: [id], onDelete: SetNull)

  @@index([userId, provider])
  @@index([deploymentId])
  @@index([status])
  @@index([sshKeyId])
}

model ShipyardBillingWallet {
  id          String                  @id @default(cuid())
  userId      String                  @unique
  currency    ShipyardBillingCurrency @default(eur)
  balanceCents Int                    @default(0)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  user        User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  topups      ShipyardBillingTopup[]
  ledgerEntries ShipyardBillingLedgerEntry[]

  @@index([userId])
}

model ShipyardBillingTopup {
  id                     String                   @id @default(cuid())
  walletId               String
  userId                 String
  stripeCheckoutSessionId String                 @unique
  stripePaymentIntentId  String?
  amountCents            Int
  currency               ShipyardBillingCurrency @default(eur)
  status                 ShipyardBillingTopupStatus @default(pending)
  metadata               Json?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  completedAt            DateTime?

  wallet                 ShipyardBillingWallet    @relation(fields: [walletId], references: [id], onDelete: Cascade)
  user                   User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([walletId, createdAt])
  @@index([userId, createdAt])
  @@index([status, createdAt])
}

model ShipyardBillingLedgerEntry {
  id             String                   @id @default(cuid())
  walletId       String
  userId         String
  type           ShipyardBillingLedgerType
  deltaCents     Int
  balanceAfterCents Int
  currency       ShipyardBillingCurrency @default(eur)
  referenceType  String?
  referenceId    String?
  metadata       Json?
  createdAt      DateTime                 @default(now())

  wallet         ShipyardBillingWallet    @relation(fields: [walletId], references: [id], onDelete: Cascade)
  user           User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([walletId, createdAt])
  @@index([userId, createdAt])
  @@index([type, createdAt])
  @@index([referenceType, referenceId])
  @@unique([type, referenceType, referenceId])
}

enum VaultRagScopeType {
  ship
  fleet
  global
}

enum VaultRagSyncScope {
  ship
  fleet
  all
}

enum VaultRagSyncTrigger {
  auto
  manual
}

enum VaultRagSyncStatus {
  running
  completed
  failed
}

model VaultRagDocument {
  id               String           @id @default(cuid())
  joinedPath       String           @unique
  physicalVaultId  String
  physicalPath     String
  title            String
  scopeType        VaultRagScopeType
  shipDeploymentId String?
  contentHash      String
  byteSize         Int
  mtime            DateTime
  chunkCount       Int              @default(0)
  lastIndexedAt    DateTime         @default(now())
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  chunks           VaultRagChunk[]

  @@index([scopeType, shipDeploymentId])
  @@index([physicalVaultId])
  @@index([updatedAt])
}

model VaultRagChunk {
  id               String           @id @default(cuid())
  documentId       String
  joinedPath       String
  scopeType        VaultRagScopeType
  shipDeploymentId String?
  chunkIndex       Int
  heading          String?
  content          String
  normalizedContent String
  embedding        Json?
  tokenCount       Int
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  document         VaultRagDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, chunkIndex])
  @@index([joinedPath])
  @@index([scopeType, shipDeploymentId])
}

model VaultRagSyncRun {
  id               String           @id @default(cuid())
  trigger          VaultRagSyncTrigger
  scope            VaultRagSyncScope
  status           VaultRagSyncStatus @default(running)
  shipDeploymentId String?
  initiatedByUserId String?
  mode             String?
  documentsScanned Int              @default(0)
  documentsUpserted Int             @default(0)
  documentsRemoved Int              @default(0)
  chunksUpserted   Int              @default(0)
  error            String?
  startedAt        DateTime         @default(now())
  completedAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([status, createdAt])
  @@index([scope, shipDeploymentId, createdAt])
}

model LocalPrivateRagDocument {
  id               String                @id @default(cuid())
  joinedPath       String                @unique
  physicalPath     String
  title            String
  contentHash      String
  byteSize         Int
  mtime            DateTime
  chunkCount       Int                   @default(0)
  lastIndexedAt    DateTime              @default(now())
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  chunks           LocalPrivateRagChunk[]

  @@index([updatedAt])
}

model LocalPrivateRagChunk {
  id                String                @id @default(cuid())
  documentId        String
  joinedPath        String
  chunkIndex        Int
  heading           String?
  content           String
  normalizedContent String
  embedding         Json?
  tokenCount        Int
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  document          LocalPrivateRagDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, chunkIndex])
  @@index([joinedPath])
}

model UserMemorySigner {
  id        String   @id @default(cuid())
  userId    String   @unique
  keyRef    String   @unique
  address   String
  key       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BridgeDispatchDelivery {
  id                String               @id @default(cuid())
  deploymentId      String
  connectionId      String
  source            BridgeDispatchSource
  status            BridgeDispatchStatus @default(pending)
  dedupeKey         String               @unique
  message           String
  payload           Json?
  attempts          Int                  @default(0)
  nextAttemptAt     DateTime?
  providerMessageId String?
  result            Json?
  lastError         String?
  deliveredAt       DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  deployment        AgentDeployment      @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  connection        BridgeConnection     @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([deploymentId, createdAt])
  @@index([connectionId, createdAt])
  @@index([status, nextAttemptAt])
  @@index([source, createdAt])
}

enum DeploymentType {
  agent
  ship
}

enum DeploymentProfile {
  local_starship_build
  cloud_shipyard
}

enum CloudProvider {
  hetzner
}

enum ShipyardBillingCurrency {
  eur
}

enum ShipyardBillingTopupStatus {
  pending
  completed
  expired
  failed
}

enum ShipyardBillingLedgerType {
  topup_credit
  launch_debit
  launch_refund
  manual_adjustment
}

enum ShipyardTunnelStatus {
  stopped
  starting
  running
  failed
}

enum ProvisioningMode {
  terraform_ansible
  terraform_only
  ansible_only
}

enum NodeType {
  local
  cloud
  hybrid
}

enum DeploymentStatus {
  pending
  deploying
  active
  inactive
  failed
  updating
}

model BridgeCrew {
  id            String          @id @default(cuid())
  deploymentId  String
  role          BridgeCrewRole
  callsign      String
  name          String
  description   String?
  content       String
  status        BridgeCrewStatus @default(active)
  walletEnabled Boolean         @default(false)
  walletAddress String?
  walletKeyRef  String?
  walletEnclaveUrl String?
  metadata      Json?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  deployment    AgentDeployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  bridgeAgentChatRoomsCreated BridgeAgentChatRoom[] @relation("BridgeAgentChatRoomCreator")
  bridgeAgentChatMembers BridgeAgentChatMember[]
  bridgeAgentChatMessages BridgeAgentChatMessage[] @relation("BridgeAgentChatMessageSender")
  bridgeAgentChatReplyJobs BridgeAgentChatReplyJob[] @relation("BridgeAgentChatReplyRecipient")
  shipToolGrants ShipToolGrant[] @relation("ShipToolGrantBridgeCrew")
  shipToolAccessRequests ShipToolAccessRequest[] @relation("ShipToolAccessRequestRequesterBridgeCrew")

  @@unique([deploymentId, role])
  @@index([deploymentId])
  @@index([walletEnabled])
  @@index([walletKeyRef])
}

enum BridgeCrewRole {
  xo
  ops
  eng
  sec
  med
  cou
}

enum BridgeCrewStatus {
  active
  inactive
}

model BridgeCharacterAsset {
  id          String         @id @default(cuid())
  role        BridgeCrewRole @unique
  modelUrl    String
  meshyTaskId String?
  updatedAt   DateTime       @updatedAt
}

enum BridgeConnectionProvider {
  telegram
  discord
  whatsapp
}

enum BridgeDispatchSource {
  cou_auto
  manual
  test
}

enum BridgeDispatchStatus {
  pending
  processing
  completed
  failed
}

model ApplicationDeployment {
  id            String              @id @default(cuid())
  name          String
  description   String?
  applicationType ApplicationType
  image         String?
  repository    String?
  branch        String?
  buildCommand  String?
  startCommand  String?
  port          Int?
  environment   Json?
  shipDeploymentId String
  nodeId        String
  nodeType      NodeType
  deploymentProfile DeploymentProfile @default(local_starship_build)
  provisioningMode ProvisioningMode @default(terraform_ansible)
  nodeUrl       String?
  status        DeploymentStatus    @default(pending)
  config        Json?
  metadata      Json?
  deployedAt    DateTime?
  lastHealthCheck DateTime?
  healthStatus  String?
  version       String?
  userId        String
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  shipDeployment AgentDeployment     @relation(fields: [shipDeploymentId], references: [id], onDelete: Cascade)
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([shipDeploymentId])
  @@index([nodeId])
  @@index([status])
  @@index([userId])
  @@index([applicationType])
  @@index([deploymentProfile])
}

enum ApplicationType {
  docker
  nodejs
  python
  static
  custom
}

model Project {
  id            String        @id @default(cuid())
  name          String
  description   String?
  slug          String        @unique
  isPublic      Boolean       @default(false)
  tags          String[]
  repository    String?
  website       String?
  readme        String?
  thumbnail     String?
  category      ProjectCategory?
  stars         Int           @default(0)
  views         Int           @default(0)
  userId        String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isPublic])
  @@index([slug])
  @@index([category])
}

enum ProjectCategory {
  ai_agent
  automation
  tool
  library
  application
  other
}

model NodeSource {
  id         String   @id @default(cuid())
  nodeId     String
  name       String?
  nodeType   NodeType?
  nodeUrl    String?
  apiKeyHash String
  isActive   Boolean  @default(true)
  lastSeenAt DateTime?
  ownerUserId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  events          ForwardingEvent[]
  nonces          ForwardingNonce[]
  sourceConfigs   ForwardingConfig[] @relation("ForwardingConfigSource")
  owner           User?              @relation("NodeSourceOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  @@unique([ownerUserId, nodeId])
  @@index([ownerUserId])
}

model ForwardingEvent {
  id          String               @id @default(cuid())
  sourceNodeId String
  dedupeKey   String               @unique
  eventType   ForwardingEventType
  payload     Json
  metadata    Json?
  occurredAt  DateTime
  receivedAt  DateTime             @default(now())
  status      ForwardingEventStatus @default(received)

  sourceNode NodeSource @relation(fields: [sourceNodeId], references: [id], onDelete: Cascade)

  @@index([sourceNodeId])
  @@index([eventType])
  @@index([occurredAt])
  @@index([status])
}

model ForwardingNonce {
  id          String   @id @default(cuid())
  sourceNodeId String
  nonce       String
  timestamp   DateTime
  createdAt   DateTime @default(now())

  sourceNode NodeSource @relation(fields: [sourceNodeId], references: [id], onDelete: Cascade)

  @@unique([sourceNodeId, nonce])
  @@index([timestamp])
}

model ForwardingConfig {
  id          String               @id @default(cuid())
  userId      String
  sourceNodeId String?
  targetUrl   String
  targetApiKey String?
  enabled     Boolean              @default(false)
  eventTypes  ForwardingEventType[]
  status      ForwardingTargetStatus @default(paused)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceNode NodeSource? @relation("ForwardingConfigSource", fields: [sourceNodeId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([enabled])
}

model ObservabilityTrace {
  id        String   @id @default(cuid())
  traceId   String   @unique
  userId    String?
  sessionId String?
  source    String?
  status    String?
  payload   Json
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User?                            @relation(fields: [userId], references: [id], onDelete: SetNull)
  session       Session?                         @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  decryptAudits ObservabilityTraceDecryptAudit[]

  @@index([userId, createdAt])
  @@index([sessionId, createdAt])
  @@index([createdAt])
}

model ObservabilityTraceDecryptAudit {
  id        String   @id @default(cuid())
  traceId   String
  actorType String
  actorId   String
  actorEmail String?
  createdAt DateTime @default(now())

  trace     ObservabilityTrace @relation(fields: [traceId], references: [id], onDelete: Cascade)
  @@index([traceId, createdAt])
  @@index([actorType, createdAt])
}

model RagPerformanceSample {
  id               String   @id @default(cuid())
  userId           String?
  sessionId        String?
  shipDeploymentId String?
  route            String
  operation        String
  requestedBackend String
  effectiveBackend String
  mode             String?
  scope            String?
  status           String
  fallbackUsed     Boolean  @default(false)
  durationMs       Int
  resultCount      Int?
  queryHash        String?
  queryLength      Int?
  errorCode        String?
  createdAt        DateTime @default(now())

  user           User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  session        Session?         @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  shipDeployment AgentDeployment? @relation("RagPerformanceSampleShipDeployment", fields: [shipDeploymentId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([status, createdAt])
  @@index([effectiveBackend, createdAt])
  @@index([route, operation, createdAt])
  @@index([shipDeploymentId, createdAt])
  @@index([userId, createdAt])
}

model RuntimePerformanceSample {
  id             String   @id @default(cuid())
  userId         String?
  sessionId      String?
  source         String
  runtimeProfile String?
  provider       String?
  status         String
  fallbackUsed   Boolean  @default(false)
  durationMs     Int
  errorCode      String?
  createdAt      DateTime @default(now())

  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  session Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([status, createdAt])
  @@index([provider, createdAt])
  @@index([runtimeProfile, createdAt])
  @@index([source, createdAt])
  @@index([userId, createdAt])
}

enum NewsletterSubscriptionStatus {
  subscribed
  unsubscribed
}

model NewsletterSubscription {
  id            String                       @id @default(cuid())
  email         String                       @unique
  userId        String?
  source        String
  status        NewsletterSubscriptionStatus @default(subscribed)
  metadata      Json?
  subscribedAt  DateTime                     @default(now())
  unsubscribedAt DateTime?
  createdAt     DateTime                     @default(now())
  updatedAt     DateTime                     @updatedAt

  user          User?                        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([status, createdAt])
}

enum ForwardingEventType {
  session
  task
  command_execution
  verification
  action
  deployment
  application
  bridge_station
  system_status
}

enum ForwardingEventStatus {
  received
  projected
  duplicate
  rejected
}

enum ForwardingTargetStatus {
  active
  paused
  failed
}

model GitHubWebhookEvent {
  id                String   @id @default(cuid())
  eventType         String
  action            String?
  repository        String?
  pullRequestNumber Int?
  commentId         Int?
  commentBody       String?
  payload           Json
  status            String   @default("received")
  responseBody      Json?
  error             String?
  createdAt         DateTime @default(now())
  processedAt       DateTime?

  @@index([eventType])
  @@index([action])
  @@index([repository])
  @@index([createdAt])
}

model ShipTopology {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String
  teamId      String?  @default("uss-k8s")

  components  Json
  edges       Json
  positions   Json?
  hierarchy   Json?

  isDefault   Boolean  @default(false)
  version     Int      @default(1)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([teamId])
  @@index([isDefault])
}
